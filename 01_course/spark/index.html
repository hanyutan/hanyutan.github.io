<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Spark - Keep Learning</title>
<meta name="description" content="Han Yutan">
<meta name="generator" content="Hugo 0.58.1" />
<link href="https://hanyutan.gitee.ioindex.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="https://hanyutan.gitee.io/01_course/spark/">
<link rel="stylesheet" href="https://hanyutan.gitee.io/css/theme.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="https://hanyutan.gitee.io/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://hanyutan.gitee.io/js/functions.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<script src="https://hanyutan.gitee.io/js/jquery.backtothetop/jquery.backtothetop.min.js"></script><script type="text/x-mathjax-config">
MathJax.Hub.Config({
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$']],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    messageStyle: "none",
    "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</head>
<body>
<div class="container"><header>
<h1>Keep Learning</h1>

 <span class="version">Version 1.0</span>
<a href="https://gitee.com/hanyutan" class="github"><i class="fab fa-github"></i></a>
<p class="description">Han Yutan</p>

</header>
<div class="menu">
<nav>
<ul>
<li><a href="/">Home</a></li>
<li><a href="https://www.instagram.com/philoartist97/">Instagram</a></li>
<li><a href="/default_post/goisforlovers/">(Hu)go Template Primer</a></li>
<li><a href="/about/">About Hugo</a></li>
<li><a href="/default_post/hugoisforlovers/">Getting Started with Hugo</a></li><li class="parent"><a href="">Tutorials<i class="fas fa-angle-right"></i></a>
<ul class="sub-menu">
<li class="child"><a href="/default_post/creating-a-new-theme/">Creating a New Theme</a></li>
<li class="child"><a href="/default_post/migrate-from-jekyll/">Migrating from Jekyll</a></li>
</ul>
</li></ul>
</nav>
</div>
<div class="content-container">
<main><h1>Spark</h1>

<h2 id="spark-r">Spark+R</h2>

<h3 id="databricks平台">Databricks平台</h3>

<p>集成了Spark环境，支持Scala、python、R语言进行开发。</p>

<p>学生可以注册<a href="https://accounts.cloud.databricks.com/registration.html#signup/community">社区版本</a>，拥有一台配置为6G内存的Spark集群环境</p>

<p>进入平台界面，侧边栏Clusters创建集群；
Data中导入数据文件Add Data&ndash;Upload File&ndash;browse&ndash;Create Table with UI&ndash;更改字段类型；</p>

<p><a href="https://www.jianshu.com/p/2a0b5c7274b7">https://www.jianshu.com/p/2a0b5c7274b7</a></p>

<p>Databrick free community edition account open:
<a href="https://accounts.cloud.databricks.com/registration.html#signup/community">https://accounts.cloud.databricks.com/registration.html#signup/community</a></p>

<p>Example can be imported from:
<a href="https://databricks-prodcloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/2961012104553482/3725396058299890/1806228006848429/latest.html">https://databricks-prodcloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/2961012104553482/3725396058299890/1806228006848429/latest.html</a></p>

<h3 id="other-useful-links">other useful links</h3>

<p><a href="https://github.com/happyrabbit">https://github.com/happyrabbit</a></p>

<p><a href="https://github.com/happyrabbit/Awesome-Data-Science-Materials">https://github.com/happyrabbit/Awesome-Data-Science-Materials</a></p>

<p><a href="https://course2019/scientistcafe.com/">https://course2019/scientistcafe.com/</a></p>

<p><a href="https://scientistcafe.com/ids/">https://scientistcafe.com/ids/</a></p>

<p><a href="https://docs.databricks.com/spark/latest/sparkr/sparklyr.html">https://docs.databricks.com/spark/latest/sparkr/sparklyr.html</a></p>

<p><a href="http://spark.rstudio.com/index.html">http://spark.rstudio.com/index.html</a></p>

<p><a href="https://spark.rstudio.com/dplyr/">https://spark.rstudio.com/dplyr/</a></p>

<p><a href="http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html">http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html</a></p>

<p><a href="http://r-statistics.co/">http://r-statistics.co/</a></p>

<h3 id="本地rstuido使用-sparklyr-dpylr">本地RStuido使用 (sparklyr &amp; dpylr)</h3>

<p>在R中安装本地spark，使用Java8u221版本，Java9以上得手动进行spark的配置。此外注意：
同时使用sparklyr/dplyr和SparkR时会有函数名称被mask，应使用<code>&lt;package&gt;::&lt;function&gt;</code>来指定。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r">install.packages<span class="p">(</span><span class="s">&#34;Rcpp&#34;</span><span class="p">)</span> <span class="c1"># Update Rcpp package</span>
install.packages<span class="p">(</span><span class="s">&#34;dplyr&#34;</span><span class="p">)</span>
install.packages<span class="p">(</span><span class="s">&#34;sparklyr&#34;</span><span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>sparklyr<span class="p">)</span>
spark_install<span class="p">(</span>version <span class="o">=</span> <span class="s">&#34;2.1.0&#34;</span><span class="p">)</span> <span class="c1"># 本地安装spark</span>
install.packages<span class="p">(</span><span class="s">&#34;SparkR&#34;</span><span class="p">)</span></code></pre></div>
<h3 id="load-packages">Load packages</h3>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># Clear the Environment</span>
<span class="kp">rm</span><span class="p">(</span><span class="kt">list</span><span class="o">=</span><span class="kp">ls</span><span class="p">())</span>

<span class="c1"># Load packages</span>
<span class="kn">library</span><span class="p">(</span>sparklyr<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>gridExtra<span class="p">)</span> <span class="c1"># grid.arrange() </span>
                   <span class="c1"># Arrange multiple grobs on a page</span></code></pre></div>
<h3 id="load-datasets">Load datasets</h3>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># read data into Spark DataFrames</span>

spark_read_csv
spark_read_json
spark_read_parquet
<span class="s">&#34;&#34;&#34;
</span><span class="s">Regardless of the format of your data, Spark supports reading data from a variety of
</span><span class="s">different data sources. These include data stored on HDFS (hdfs:// protocol), Amazon
</span><span class="s">S3 (s3n:// protocol), or local files available to the Spark worker nodes (file:// protocol)
</span><span class="s">Each of these functions returns a reference to a Spark DataFrame which can be used as a dplyr table (tbl)
</span><span class="s">&#34;&#34;&#34;</span>

<span class="c1"># read and write data</span>
temp_csv <span class="o">&lt;-</span> <span class="kp">tempfile</span><span class="p">(</span>fileext <span class="o">=</span> <span class="s">&#34;.csv&#34;</span><span class="p">)</span>
temp_parquet <span class="o">&lt;-</span> <span class="kp">tempfile</span><span class="p">(</span>fileext <span class="o">=</span> <span class="s">&#34;.parquet&#34;</span><span class="p">)</span>
temp_json <span class="o">&lt;-</span> <span class="kp">tempfile</span><span class="p">(</span>fileext <span class="o">=</span> <span class="s">&#34;.json&#34;</span><span class="p">)</span>

spark_write_csv<span class="p">(</span>flights_tbl<span class="p">,</span> temp_csv<span class="p">)</span>
flights_csv_tbl <span class="o">&lt;-</span> spark_read_csv<span class="p">(</span>sc<span class="p">,</span> <span class="s">&#34;flights_csv&#34;</span><span class="p">,</span> temp_csv<span class="p">)</span>

spark_write_parquet<span class="p">(</span>flights_tbl<span class="p">,</span> temp_parquet<span class="p">)</span>
flights_parquet_tbl <span class="o">&lt;-</span> spark_read_parquet<span class="p">(</span>sc<span class="p">,</span> <span class="s">&#34;flights_parquet&#34;</span><span class="p">,</span> temp_parquet<span class="p">)</span>

spark_write_json<span class="p">(</span>flights_tbl<span class="p">,</span> temp_json<span class="p">)</span>
flights_json_tbl <span class="o">&lt;-</span> spark_read_json<span class="p">(</span>sc<span class="p">,</span> <span class="s">&#34;flights_json&#34;</span><span class="p">,</span> temp_json<span class="p">)</span></code></pre></div>
<h3 id="spark-connection-copy-dataframe">Spark connection &amp; copy dataframe</h3>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># Create a Spark Connection</span>
sc <span class="o">&lt;-</span> spark_connect<span class="p">(</span>master <span class="o">=</span> <span class="s">&#34;local&#34;</span><span class="p">)</span>   <span class="c1"># pipe that connects R to the Spark Cluster</span>
                                        <span class="c1"># sc &lt;- spark_connect(method = &#34;databricks&#34;)</span>
src_tbls<span class="p">(</span>sc<span class="p">)</span>                            <span class="c1"># code to return all the data frames associated with sc</span>

<span class="c1"># Copy Local R DataFrame into Spark DataFrame</span>
<span class="c1"># refer Spark DataFrame &#39;iris&#39;(spark) through &#39;iris_tbl&#39;(r)</span>
<span class="o">&lt;</span>dataset_tbl<span class="o">&gt;</span> <span class="o">&lt;-</span> sdf_copy_to<span class="p">(</span>sc<span class="p">,</span> <span class="o">&lt;</span>dataset<span class="o">&gt;</span><span class="p">,</span> overwrite <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>   <span class="c1"># sdf_copy_to和copy_to的区别？？？</span>

<span class="c1"># establish connection between local R object &#39;my_df_tbl&#39; to *existing* Spark DataFrame &#39;my_df&#39;</span>
my_df_tbl <span class="o">&lt;-</span> tbl<span class="p">(</span>sc<span class="p">,</span> my_df<span class="p">)</span></code></pre></div>
<h3 id="dplyr-manipulation">Dplyr manipulation</h3>

<p>With the sparklyr packages, we can use many functions in dplyr to Spark DataFrame directly to dataset_tbl,
we cannot apply functions from other packages to Spark DataFrame direction (such as ggplot()),
need to bring data back to R Notebook using collect() function</p>

<p>When connected to a Spark DataFrame, dplyr translates the commands into Spark SQL statements.</p>

<h3 id="spark-machine-learning">Spark Machine Learning</h3>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"></code></pre></div>
<h2 id="introduction-to-spark">Introduction to Spark</h2>

<h3 id="spark框架概念">Spark框架概念</h3>

<p>Spark是一款基于内存的分布式计算框架，具有简洁接口，可以快速构建上层数据分析算法。</p>

<ul>
<li>基于内存计算，处理快</li>
<li>Hapdooop中计算框架MapReduce的替代方案，兼容HDFS、Hive等分布式存储层</li>
<li>执行工作流抽象为有向无环图执行计划（DAG），可以将多Stage的任务串联或者并行执行，无需将中间结果输出到HDFS</li>
<li>抽象出分布式内存存储结构 弹性分布式数据集 RDD，理解为用分布式的数组进行数据存储</li>
<li>可以控制数据在不同节点上的分区，用户自定义分区策略</li>
<li>执行过程中不同Stage之间需要进行Shuffle（连接有依赖的Stage的桥梁）将相同的分组数据拆分后聚合到同一个节点再处理</li>
<li>采用事件驱动的类库AKKA来启动任务，通过线程池的复用线程来避免系统启动和切换开销</li>
</ul>

<h3 id="spark生态系统bdas">Spark生态系统BDAS</h3>

<p>Spark生态系统已经发展成为一个包含多个子项目的集合，其中有SparkSQL(结构化数据查询分析)、Spark Streaming(流计算框架)、GraphX(并行图计算框架)、MLlib(分布式机器学习库)等子项目。</p>

<p>BDAS是伯克利大学提出的基于Spark的数据分析栈，核心框架是Spark</p>

<p>架构 RDD</p>

<p>RDD支持粗粒度写操作，但对于读取可以精确到每条记录。
RDD模型适合粗粒度的全局数据并行计算，不适合细粒度的、需要异步更新的计算。</p>

<h3 id="install">Install</h3>

<ul>
<li>spark：<code>scoop install spark</code></li>
<li>JDK8：<code>scoop bucket add java</code>，然后<code>scoop install oraclejdk12</code></li>
<li>Intellij IDEA：<code>scoop bucket add JetBrains</code>，然后<code>scoop install IntelliJ-IDEA</code></li>
<li>Scala：<code>scoop install scala</code></li>
</ul>
<div class="edit-meta">
Last updated on 7 Oct 2019


<br>
Published on 7 Oct 2019
<br><a href="https://gitee.com/hanyutan/hanyutan/edit/master/content/01_course%5cspark.md" class="edit-page"><i class="fas fa-pen-square"></i> Edit on GitHub</a></div><nav class="pagination"><a class="nav nav-prev" href="/01_course/financial_risk_management/exam/" title="Exam"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - Exam</a>
<a class="nav nav-next" href="/01_course/python_cheat_sheet/" title="Python Cheat Sheet">Next - Python Cheat Sheet <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav><footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://themes.gohugo.io/hugo-theme-techdoc/">TechDoc</a>. Designed by <a href="https://github.com/thingsym/hugo-theme-techdoc">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">
<nav>
<ul>
<li class=""><a href="https://hanyutan.gitee.io">Home</a></li>

<li class="parent"><a href="/01_course/">Course</a>
<ul class="sub-menu">
<li class=""><a href="/01_course/r_cheat_sheet/">R Cheat-Sheet</a></li>
<li class="active"><a href="/01_course/spark/">Spark</a></li>
<li class=""><a href="/01_course/latex/">Latex</a></li>

<li class=""><a href="/01_course/python_cheat_sheet/">Python Cheat Sheet</a>
<ul class="">
<li class=""><a href="/01_course/python_cheat_sheet/basic/">Basic</a></li>
<li class=""><a href="/01_course/python_cheat_sheet/pandas/">Pandas</a></li>
<li class=""><a href="/01_course/python_cheat_sheet/plot/">Plot</a></li>
<li class=""><a href="/01_course/python_cheat_sheet/numpy/">Numpy</a></li>
<li class=""><a href="/01_course/python_cheat_sheet/data_preprocessing/">Data Pre-processing</a></li>
</ul>
  
</li>

<li class=""><a href="/01_course/financial_risk_management/">Financial Risk Management</a>
<ul class="">
<li class=""><a href="/01_course/financial_risk_management/markowitz/">Markowitz</a></li>
<li class=""><a href="/01_course/financial_risk_management/binomial_trees/">Binomial Trees</a></li>
<li class=""><a href="/01_course/financial_risk_management/bsm_model/">BSM Model</a></li>
<li class=""><a href="/01_course/financial_risk_management/greeks/">Hedging with the Greeks</a></li>
<li class=""><a href="/01_course/financial_risk_management/exam/">Exam</a></li>
</ul>
  
</li>
</ul>
  
</li>

<li class=""><a href="/02_big_data/">Big Data Analysis</a>
<ul class="">

<li class=""><a href="/02_big_data/machine_learning/">Machine Learning</a>
<ul class="">
<li class=""><a href="/02_big_data/machine_learning/random_forest/">Random Forest</a></li>
<li class=""><a href="/02_big_data/machine_learning/bagging/">Bagging</a></li>
<li class=""><a href="/02_big_data/machine_learning/knn/">KNN</a></li>
<li class=""><a href="/02_big_data/machine_learning/linear_regression/">Linear Regression</a></li>
<li class=""><a href="/02_big_data/machine_learning/pca/">PCA</a></li>
<li class=""><a href="/02_big_data/machine_learning/train_test/">Train &amp; Test</a></li>
<li class=""><a href="/02_big_data/machine_learning/clustering/">Clustering</a></li>
<li class=""><a href="/02_big_data/machine_learning/naive_bayes/">Naive Bayes</a></li>
</ul>
  
</li>
<li class=""><a href="/02_big_data/gan/">GAN</a></li>
<li class=""><a href="/02_big_data/tensorflow/">Tensorflow</a></li>

<li class=""><a href="/02_big_data/reinforcement_learning/">Reinforcement Learning</a>
<ul class="">
<li class=""><a href="/02_big_data/reinforcement_learning/rl_with_kg/">RL with KG</a></li>
</ul>
  
</li>

<li class=""><a href="/02_big_data/text_mining/">Text Mining</a>
<ul class="">
<li class=""><a href="/02_big_data/text_mining/regular_expression/">Regular Expression</a></li>
</ul>
  
</li>
<li class=""><a href="/02_big_data/caffe/">Caffe</a></li>
<li class=""><a href="/02_big_data/data_mining/">Data Mining</a></li>
</ul>
  
</li>

<li class=""><a href="/build_blog/">Build Blogs</a>
<ul class="">
<li class=""><a href="/build_blog/01_introduction/">Introduction</a></li>
<li class=""><a href="/build_blog/02_preparation/">Preparation</a></li>
<li class=""><a href="/build_blog/03_quick_start/">Quick Start</a></li>
<li class=""><a href="/build_blog/04_git_notes/">Git Notes</a></li>
<li class=""><a href="/build_blog/05_hugo_notes/">Hugo Notes</a></li>
<li class=""><a href="/build_blog/06_markdown_notes/">Markdown Notes</a></li>
<li class=""><a href="/build_blog/07_questions/">Q&amp;A</a></li>
<li class=""><a href="/build_blog/scoop/">Scoop</a></li>
</ul>
  
</li>

<li class=""><a href="/03_interests/">Interests</a>
<ul class="">
<li class=""><a href="/03_interests/japanese/">Japanese</a></li>
<li class=""><a href="/03_interests/hunt_for_stars/">Hunt for Stars</a></li>
<li class=""><a href="/03_interests/diy_pc/">DIY PC</a></li>
</ul>
  
</li>

<li class=""><a href="/04_reading/">Reading</a>
<ul class="">
<li class=""><a href="/04_reading/reading_notes/">Reading Notes</a></li>
<li class=""><a href="/04_reading/nonsense_output/">Nonsense Output</a></li>
<li class=""><a href="/04_reading/wisdom_from_others/">Wisdom From Others</a></li>
</ul>
  
</li>

<li class=""><a href="/mathematics/">Mathematics</a>
<ul class="">
<li class=""><a href="/mathematics/advanced_mathematical_statistics/">Mathematical Analysis</a></li>
<li class=""><a href="/mathematics/mathematical_analysis/">Mathematical Analysis</a></li>
<li class=""><a href="/mathematics/functional_analysis/">Functional Analysis</a></li>
</ul>
  
</li>

<li class=""><a href="/digital_content/">Digital Content</a>
<ul class="">
<li class=""><a href="/digital_content/opengl/">OpenGL</a></li>
<li class=""><a href="/digital_content/shader/">Shader</a></li>
<li class=""><a href="/digital_content/3dmax/">3dmax</a></li>
<li class=""><a href="/digital_content/smpl/">SMPL</a></li>
<li class=""><a href="/digital_content/image_processing/">Image Processing</a></li>
<li class=""><a href="/digital_content/affine_transformation/">Affine Transformation</a></li>
</ul>
  
</li>

<li class=""><a href="/chapter3/">Chapter 3 (hierarchized)</a>
<ul class="">
<li class=""><a href="/chapter3/1/">Chapter 3-1</a></li>

<li class=""><a href="/chapter3/chapter3-2/">Chapter 3-2</a>
<ul class="">
<li class=""><a href="/chapter3/chapter3-2/1/">Chapter 3-2-1</a></li>
<li class=""><a href="/chapter3/chapter3-2/2/">Chapter 3-2-2</a></li>
<li class=""><a href="/chapter3/chapter3-2/3/">Chapter 3-2-3</a></li>
<li class=""><a href="/chapter3/chapter3-2/4/">Chapter 3-2-4</a></li>
</ul>
  
</li>
<li class=""><a href="/chapter3/3/">Chapter 3-3</a></li>
<li class=""><a href="/chapter3/4/">Chapter 3-4</a></li>
</ul>
  
</li>

<li class=""><a href="/default_post/">Default_posts</a>
<ul class="">
<li class=""><a href="/default_post/installation/">Installation</a></li>
<li class=""><a href="/default_post/creating-a-new-theme/">Creating a New Theme</a></li>
<li class=""><a href="/default_post/migrate-from-jekyll/">Migrate to Hugo from Jekyll</a></li>
<li class=""><a href="/default_post/configuration/">Configuration</a></li>
<li class=""><a href="/default_post/goisforlovers/">(Hu)go Template Primer</a></li>
<li class=""><a href="/default_post/hugoisforlovers/">Getting Started with Hugo</a></li>
</ul>
  
</li>
</ul>
</nav>


<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>
